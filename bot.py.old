#!/usr/bin/env python3
"""
–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π Telegram-–±–æ—Ç –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Å–æ–ª—å–Ω–∏–º–∏ –ø—Ä–æ–≥—Ä–∞–º–∞–º–∏
–ó–∞–ø—É—Å–∫–∞—î –ø—Ä–æ–≥—Ä–∞–º–∏, –ø–µ—Ä–µ–¥–∞—î –≤–∏–≤—ñ–¥ —É TG, –ø—Ä–∏–π–º–∞—î –≤–≤—ñ–¥ –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
"""

import asyncio
import logging
import os
import sys
from typing import Optional
from enum import Enum

from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove, KeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, ConversationHandler
from dotenv import load_dotenv

# –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
load_dotenv()

# –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
BOT_TOKEN = os.getenv('BOT_TOKEN')
ADMIN_CHAT_ID = int(os.getenv('ADMIN_CHAT_ID', '0'))

if not BOT_TOKEN or not ADMIN_CHAT_ID:
    logger.error("BOT_TOKEN –∞–±–æ ADMIN_CHAT_ID –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ –≤ .env —Ñ–∞–π–ª—ñ")
    sys.exit(1)

# –°—Ç–∞–Ω–∏ conversation
class State(Enum):
    WAITING_COMMAND = 1
    PROCESS_RUNNING = 2

# –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—É
active_process: Optional[asyncio.subprocess.Process] = None
output_task: Optional[asyncio.Task] = None

# –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞
def get_main_keyboard():
    """–ì–æ–ª–æ–≤–Ω–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –∑ –∫–Ω–æ–ø–∫–∞–º–∏"""
    keyboard = [
        [KeyboardButton("üöÄ Start Program")],
        [KeyboardButton("üõë Stop Program"), KeyboardButton("üìä Status")],
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)


async def send_long_message(bot: Bot, chat_id: int, text: str, max_length: int = 4000):
    """–ù–∞–¥—Å–∏–ª–∞—î –¥–æ–≤–≥—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–∞—Å—Ç–∏–Ω–∞–º–∏"""
    for i in range(0, len(text), max_length):
        chunk = text[i:i + max_length]
        await bot.send_message(chat_id, f"```\n{chunk}\n```", parse_mode="Markdown")
        await asyncio.sleep(0.1)


async def read_stream_and_send(stream, bot: Bot, chat_id: int, prefix: str = ""):
    """–ß–∏—Ç–∞—î –≤–∏–≤—ñ–¥ –∑ –ø—Ä–æ—Ü–µ—Å—É —Ç–∞ –Ω–∞–¥—Å–∏–ª–∞—î —É Telegram"""
    buffer = ""
    try:
        while True:
            line = await stream.readline()
            if not line:
                break
            
            decoded = line.decode('utf-8', errors='replace').rstrip()
            logger.info(f"{prefix}{decoded}")
            buffer += decoded + "\n"
            
            # –ù–∞–¥—Å–∏–ª–∞—î–º–æ –ø–æ 10 —Ä—è–¥–∫—ñ–≤ –∞–±–æ –∫–æ–∂–Ω—ñ 2 —Å–µ–∫—É–Ω–¥–∏
            if buffer.count('\n') >= 10:
                await send_long_message(bot, chat_id, buffer)
                buffer = ""
            
    except Exception as e:
        logger.error(f"–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è stream: {e}")
    finally:
        if buffer:
            await send_long_message(bot, chat_id, buffer)


async def start_process(command: list[str], bot: Bot, chat_id: int, state: FSMContext):
    """–ó–∞–ø—É—Å–∫–∞—î –ø—Ä–æ—Ü–µ—Å —Ç–∞ –Ω–∞–ª–∞—à—Ç–æ–≤—É—î –ø–µ—Ä–µ–¥–∞—á—É –≤–∏–≤–æ–¥—É"""
    global active_process, output_task
    
    try:
        # –°—Ç–≤–æ—Ä—é—î–º–æ –ø—Ä–æ—Ü–µ—Å
        active_process = await asyncio.create_subprocess_exec(
            *command,
            stdin=asyncio.subprocess.PIPE,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE,
        )
        
        await bot.send_message(
            chat_id,
            f"‚úÖ –ü—Ä–æ—Ü–µ—Å –∑–∞–ø—É—â–µ–Ω–æ: `{' '.join(command)}`\nPID: {active_process.pid}",
            parse_mode="Markdown"
        )
        
        # –ó–∞–ø—É—Å–∫–∞—î–º–æ —á–∏—Ç–∞–Ω–Ω—è –≤–∏–≤–æ–¥—É
        output_task = asyncio.create_task(
            asyncio.gather(
                read_stream_and_send(active_process.stdout, bot, chat_id, "[OUT] "),
                read_stream_and_send(active_process.stderr, bot, chat_id, "[ERR] ")
            )
        )
        
        await state.set_state(ProcessState.running)
        
        # –ß–µ–∫–∞—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –ø—Ä–æ—Ü–µ—Å—É
        returncode = await active_process.wait()
        await bot.send_message(
            chat_id,
            f"üèÅ –ü—Ä–æ—Ü–µ—Å –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑ –∫–æ–¥–æ–º: {returncode}",
            reply_markup=get_main_keyboard()
        )
        
    except Exception as e:
        logger.error(f"–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É –ø—Ä–æ—Ü–µ—Å—É: {e}")
        await bot.send_message(chat_id, f"‚ùå –ü–æ–º–∏–ª–∫–∞: {e}")
    finally:
        active_process = None
        output_task = None
        await state.clear()


async def stop_process(bot: Bot, chat_id: int, state: FSMContext):
    """–ó—É–ø–∏–Ω—è—î –∞–∫—Ç–∏–≤–Ω–∏–π –ø—Ä–æ—Ü–µ—Å"""
    global active_process, output_task
    
    if active_process and active_process.returncode is None:
        try:
            active_process.terminate()
            await asyncio.sleep(1)
            if active_process.returncode is None:
                active_process.kill()
            
            if output_task:
                output_task.cancel()
            
            await bot.send_message(chat_id, "üõë –ü—Ä–æ—Ü–µ—Å –∑—É–ø–∏–Ω–µ–Ω–æ", reply_markup=get_main_keyboard())
            await state.clear()
        except Exception as e:
            logger.error(f"–ü–æ–º–∏–ª–∫–∞ –∑—É–ø–∏–Ω–∫–∏ –ø—Ä–æ—Ü–µ—Å—É: {e}")
            await bot.send_message(chat_id, f"‚ùå –ü–æ–º–∏–ª–∫–∞: {e}")
    else:
        await bot.send_message(chat_id, "‚ö†Ô∏è –ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É")


@router.message(Command("start"))
async def cmd_start(message: Message):
    """–û–±—Ä–æ–±–Ω–∏–∫ –∫–æ–º–∞–Ω–¥–∏ /start"""
    if message.chat.id != ADMIN_CHAT_ID:
        await message.answer("‚õî –£ –≤–∞—Å –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ —Ü—å–æ–≥–æ –±–æ—Ç–∞")
        return
    
    await message.answer(
        "üëã –í—ñ—Ç–∞—é! –¶–µ –±–æ—Ç –¥–ª—è —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø—Ä–æ–≥—Ä–∞–º–∞–º–∏.\n\n"
        "üöÄ –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å 'Start Program' –¥–ª—è –∑–∞–ø—É—Å–∫—É\n"
        "‚úçÔ∏è –ù–∞–¥—Å–∏–ª–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –≤–≤–æ–¥—É –≤ –ø—Ä–æ–≥—Ä–∞–º—É\n"
        "üõë –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å 'Stop Program' –¥–ª—è –∑—É–ø–∏–Ω–∫–∏",
        reply_markup=get_main_keyboard()
    )


@router.message(F.text == "üöÄ Start Program")
async def button_start_program(message: Message, state: FSMContext):
    """–ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫—É –ø—Ä–æ–≥—Ä–∞–º–∏"""
    if message.chat.id != ADMIN_CHAT_ID:
        return
    
    if active_process and active_process.returncode is None:
        await message.answer("‚ö†Ô∏è –ü—Ä–æ–≥—Ä–∞–º–∞ –≤–∂–µ –∑–∞–ø—É—â–µ–Ω–∞!")
        return
    
    await message.answer(
        "üìù –í–≤–µ–¥—ñ—Ç—å –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∑–∞–ø—É—Å–∫—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: `airodump-ng wlan0mon`)\n"
        "–ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ /cancel –¥–ª—è —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è",
        reply_markup=ReplyKeyboardRemove()
    )
    await state.set_state(ProcessState.waiting_input)


@router.message(F.text == "üõë Stop Program")
async def button_stop_program(message: Message, state: FSMContext):
    """–ö–Ω–æ–ø–∫–∞ –∑—É–ø–∏–Ω–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–∏"""
    if message.chat.id != ADMIN_CHAT_ID:
        return
    
    await stop_process(message.bot, message.chat.id, state)


@router.message(F.text == "üìä Status")
async def button_status(message: Message):
    """–ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ç—É—Å—É"""
    if message.chat.id != ADMIN_CHAT_ID:
        return
    
    if active_process and active_process.returncode is None:
        await message.answer(
            f"‚úÖ –ü—Ä–æ—Ü–µ—Å –∞–∫—Ç–∏–≤–Ω–∏–π\nPID: {active_process.pid}",
            reply_markup=get_main_keyboard()
        )
    else:
        await message.answer("‚≠ï –ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É", reply_markup=get_main_keyboard())


@router.message(ProcessState.waiting_input)
async def process_command_input(message: Message, state: FSMContext):
    """–û—Ç—Ä–∏–º—É—î –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∑–∞–ø—É—Å–∫—É"""
    if message.chat.id != ADMIN_CHAT_ID:
        return
    
    command = message.text.strip().split()
    if not command:
        await message.answer("‚ùå –ü–æ—Ä–æ–∂–Ω—è –∫–æ–º–∞–Ω–¥–∞!")
        return
    
    await message.answer(f"üîÑ –ó–∞–ø—É—Å–∫–∞—é: `{' '.join(command)}`...", parse_mode="Markdown")
    
    # –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å –≤ –æ–∫—Ä–µ–º—ñ–π –∑–∞–¥–∞—á—ñ
    asyncio.create_task(start_process(command, message.bot, message.chat.id, state))


@router.message(ProcessState.running)
async def process_stdin_input(message: Message, state: FSMContext):
    """–ü–µ—Ä–µ–¥–∞—î –≤–≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ stdin –ø—Ä–æ—Ü–µ—Å—É"""
    if message.chat.id != ADMIN_CHAT_ID:
        return
    
    global active_process
    
    if not active_process or active_process.returncode is not None:
        await message.answer("‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å –Ω–µ –∞–∫—Ç–∏–≤–Ω–∏–π")
        await state.clear()
        return
    
    try:
        user_input = message.text + "\n"
        active_process.stdin.write(user_input.encode())
        await active_process.stdin.drain()
        logger.info(f"[INPUT] {message.text}")
        await message.answer(f"‚úÖ –ù–∞–¥—ñ—Å–ª–∞–Ω–æ: `{message.text}`", parse_mode="Markdown")
    except Exception as e:
        logger.error(f"–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Å—É –≤ stdin: {e}")
        await message.answer(f"‚ùå –ü–æ–º–∏–ª–∫–∞: {e}")


@router.message(Command("cancel"))
async def cmd_cancel(message: Message, state: FSMContext):
    """–°–∫–∞—Å—É–≤–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó –æ–ø–µ—Ä–∞—Ü—ñ—ó"""
    if message.chat.id != ADMIN_CHAT_ID:
        return
    
    await state.clear()
    await message.answer("‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ", reply_markup=get_main_keyboard())


async def main():
    """–ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞"""
    bot = Bot(token=BOT_TOKEN)
    dp = Dispatcher(storage=MemoryStorage())
    dp.include_router(router)
    
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ...")
    await dp.start_polling(bot)


if __name__ == '__main__':
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("–ë–æ—Ç –∑—É–ø–∏–Ω–µ–Ω–æ")
